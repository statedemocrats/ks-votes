<!DOCTYPE html>
<html>
<head>
  
  <title>Kansas Voting History</title>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>

  <script src="leaflet.ajax.min.js"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

  <style>
    #map {
      float: left;
      border: 1px solid #ddd;
      margin: 1em;
      width: 800px;
      height: 600px;
    }
    #details {
      float: right;
      border: 1px solid #ddd;
      padding: 1em;
      margin: 1em;
      max-width: 200px;
    }
    #county {
      color: #666;
    }
    #senate {
      color: #ffc300;
    }
    #house {
      color: green;
    }
    #precinct {
      color: #222;
    }
    body {
      font-family: 'Open Sans', sans-serif;
    }
  </style>

  
</head>
<body>

<div id='about'>
<h1>Kansas Voting History</h1>
Use the controls in the upper right corner of the map to toggle map layers on/off.
</div>

<div id='map'></div>
<div id='details'>
 <div id="county"></div>
 <div id="house"></div>
 <div id="senate"></div>
 <div id="precinct"></div>
</div>

<script>
  var map, counties, state_leg_lower, state_leg_upper, precincts;
  var lastCounty, lastSenate, lastHouse, lastPrecinct;
  var style = { weight: 1, opacity: 1, fillOpacity: 0 };
  var renderPolys = function(polys) {
    console.log('clicked on', polys);
    $.each(polys, function(idx, poly) {
      var props = poly.feature.properties;
      console.log(props);
      if (props['LSAD'] && props['LSAD'] == 'County') {
        $('#county').html('<h3>County</h3>' + props['NAME'] + ' [' + props['COUNTY'] + ']');
        //map.fitBounds(poly.getBounds());
        poly.setStyle({ weight: 3, color: '#666', fillOpacity: 0.1 });
        if (lastCounty && lastCounty != poly) {
          counties.resetStyle(lastCounty);
        }
        lastCounty = poly;
      }
      if (props['SLDLST']) {
        $('#house').html('<h3>House District</h3>' + props['NAME']);
        poly.setStyle({ weight: 3, color: 'green', fillOpacity: 0.1 });
        if (lastHouse && lastHouse != poly) {
          state_leg_lower.resetStyle(lastHouse);
        }
        lastHouse = poly;
      }
      if (props['SLDUST']) {
        $('#senate').html('<h3>Senate District</h3>' + props['NAME']);
        poly.setStyle({ weight: 3, color: '#ffc300', fillOpacity: 0.1 });
        if (lastSenate && lastSenate != poly) {
          state_leg_upper.resetStyle(lastSenate);
        }
        lastSenate = poly;
      }
      if (props['VTDNAME']) {
        $('#precinct').html('<h3>Precinct</h3>' + props['VTDNAME'] + ' [' + props['VTD_S'] + ']');
        poly.setStyle({ weight: 3, color: '#222', fillOpacity: 0.1 });
        if (lastPrecinct && lastPrecinct != poly) {
          precincts.resetStyle(lastPrecinct);
        }
        lastPrecinct = poly;
      }
    });
  };
  var polyClick = function(e) {
    var lng = e.latlng.lng;
    var lat = e.latlng.lat;
    var polys_clicked = [];
    var pip_counties = leafletPip.pointInLayer([lng,lat], counties);
    var pip_lower = leafletPip.pointInLayer([lng,lat], state_leg_lower);
    var pip_upper = leafletPip.pointInLayer([lng,lat], state_leg_upper);
    var pip_precincts = leafletPip.pointInLayer([lng,lat], precincts);
    if (map.hasLayer(counties)) {
      polys_clicked.push(pip_counties[0]);
    }
    if (map.hasLayer(state_leg_lower)) {
      polys_clicked.push(pip_lower[0]);
    }
    if (map.hasLayer(state_leg_upper)) {
      polys_clicked.push(pip_upper[0]);
    }
    if (map.hasLayer(precincts)) {
      polys_clicked.push(pip_precincts[0]);
    }
    renderPolys(polys_clicked);
  };
  var polyEach = function(p, layer) {
    layer.on({
      click: polyClick
    });
  };
  var opts = { style: style, onEachFeature: polyEach };

  counties = L.geoJson.ajax('ks-counties.geojson', opts);
  state_leg_lower = L.geoJson.ajax('cb_2016_20_sldl_500k.geojson', opts);
  state_leg_upper = L.geoJson.ajax('cb_2016_20_sldu_500k.geojson', opts);
  precincts = L.geoJson.ajax('kansas-state-voting-precincts-2012-min.geojson', opts);

  var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
      '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
      'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

  var grayscale = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr});
  var streets = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr});

  map = L.map('map', {
    center: [38.5138, -98.3200],
    zoom: 7,
    layers: [grayscale, counties]
  });

  var baseLayers = {
    "Grayscale": grayscale,
    "Streets": streets
  };

  var overlays = {
    "Counties": counties,
    "State Senate": state_leg_upper,
    "State House": state_leg_lower,
    "Precincts": precincts
  };

  L.control.layers(baseLayers, overlays).addTo(map);
</script>


</body>
</html>
